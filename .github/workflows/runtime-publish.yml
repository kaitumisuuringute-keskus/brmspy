name: runtime-publish

on:
  workflow_dispatch:
    inputs:
      runtime_version:
        description: "Logical runtime version (e.g. 0.2.0)"
        required: true
        type: string
        default: "0.2.0"
      tag:
        description: "Git tag for the runtime release (e.g. runtime)"
        required: false
        type: string
        default: "runtime"

jobs:
  # Create a single runtime release that all matrix jobs will attach assets to
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      upload_url: ${{ steps.get_or_create_release.outputs.upload_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get or create runtime pre-release
        id: get_or_create_release
        uses: actions/github-script@v7
        env:
          TAG: ${{ inputs.tag || format('runtime-{0}', inputs.runtime_version || '0.2.0') }}
          RUNTIME_VERSION: ${{ inputs.runtime_version || '0.2.0' }}
        with:
          script: |
            const tag = process.env.TAG;
            const runtimeVersion = process.env.RUNTIME_VERSION;
            const { owner, repo } = context.repo;

            let release;
            try {
              // Try to find existing release by tag
              release = await github.rest.repos.getReleaseByTag({
                owner,
                repo,
                tag
              });
              core.info(`Found existing release for tag ${tag}: id=${release.data.id}`);
            } catch (error) {
              if (error.status !== 404) throw error;

              core.info(`No release for tag ${tag}, creating one...`);
              release = await github.rest.repos.createRelease({
                owner,
                repo,
                tag_name: tag,
                name: `Runtimes ${runtimeVersion}`,
                body: `brmspy prebuilt runtimes ${runtimeVersion} for cmdstanr and brms.`,
                draft: false,
                prerelease: true
              });
            }

            core.setOutput("upload_url", release.data.upload_url);

  publish:
    needs: create-release
    env:
      RUNTIME_VERSION: ${{ inputs.runtime_version || '0.2.0' }}
    strategy:
      fail-fast: false
      max-parallel: 9
      matrix:
        r: ["4.5", "4.4", "4.3", "4.2", "4.1", "4.0"]
        os: [ubuntu-latest, macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}
    permissions:
      contents: write        # upload assets
      id-token: write        # for attestation
      attestations: write    # for attestation
      packages: read         # to pull GHCR image (Linux)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GHCR (Linux only)
        if: runner.os == 'Linux'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GHCR_USER: ${{ github.actor }}
        run: |
          chmod +x .runtime_builder/linux/install_r.sh
          echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin


      # ===========================
      # LINUX: build inside Docker
      # ===========================
      - name: Build Linux runtime in container
        if: runner.os == 'Linux'
        env:
          R_VERSION: "${{ matrix.r }}.0"
          RPY2_CFFI_MODE: "ABI"
        shell: bash
        run: |
          echo "== Pulling builder image =="
          docker pull ghcr.io/kaitumisuuringute-keskus/brmspy-runtime-builder:ubuntu18-gcc9

          echo "== Running builder container =="
          docker run --rm \
            -v "${PWD}:/work" \
            -w /work \
            -e R_VERSION="${R_VERSION}" \
            -e RPY2_CFFI_MODE="${RPY2_CFFI_MODE}" \
            -e RUNTIME_VERSION="${RUNTIME_VERSION}" \
            ghcr.io/kaitumisuuringute-keskus/brmspy-runtime-builder:ubuntu18-gcc9 \
            bash -lc '
              set -euo pipefail

              echo "== Toolchain =="
              ldd --version
              g++ --version
              python3.12 --version || true

              echo "== Installing R $R_VERSION =="
              .runtime_builder/linux/install_r.sh "$R_VERSION"

              echo "== Creating Python 3.12 venv =="
              python3.12 -m venv .venv
              . .venv/bin/activate

              echo "== Installing Python deps =="
              python -m pip install --upgrade pip
              python -m pip install pytest pytest-cov pytest-xdist arviz tqdm
              python -m pip install -e ".[dev]"

              echo "== Installing R deps via brmspy =="
              python -c "import brmspy; brmspy.install_brms()"

              echo "== Building runtime tarball =="
              mkdir -p dist/runtime
              python -m brmspy.build --output-dir dist/runtime --runtime-version "$RUNTIME_VERSION"

              echo "== Contents of dist/runtime =="
              ls -R dist/runtime
            '

          echo "== Locating runtime tarball on host =="
          RUNTIME_TARBALL=$(ls dist/runtime/*.tar.gz)
          if [ -z "$RUNTIME_TARBALL" ]; then
            echo "No runtime tarball found under dist/runtime" >&2
            exit 1
          fi

          RUNTIME_FILENAME=$(basename "$RUNTIME_TARBALL")
          echo "RUNTIME_TARBALL=$RUNTIME_TARBALL" >> "$GITHUB_ENV"
          echo "RUNTIME_FILENAME=$RUNTIME_FILENAME" >> "$GITHUB_ENV"
          echo "Built runtime: $RUNTIME_TARBALL"

      # ===========================
      # macOS / Windows: native
      # ===========================
      - name: Set up Python 3.12
        if: runner.os != 'Linux'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up R
        if: runner.os != 'Linux'
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r }}
          use-public-rspm: true
          # Windows only â€“ ignored on macOS / Linux
          rtools-version: >
            ${{ fromJson('{
              "4.0": "40",
              "4.1": "40",
              "4.2": "42",
              "4.3": "43",
              "4.4": "44",
              "4.5": "45"
            }')[matrix.r] }}
      
      - name: Capture R_LIBS_USER from R
        # windows silently rewrites R_LIBS_USER
        shell: bash
        run: |
          echo "R_LIBS_USER=${R_LIBS_USER}" >> "$GITHUB_ENV"
          echo "Using R_LIBS_USER=${R_LIBS_USER}"

      - name: Install Python package
        if: runner.os != 'Linux'
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest pytest-cov pytest-xdist arviz tqdm
          python -m pip install -e ".[dev]"

      - name: Install R dependencies
        if: runner.os != 'Linux'
        shell: bash
        env:
          GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RPY2_CFFI_MODE: "ABI"
        run: |
          python -c "import brmspy; brmspy.install_brms()"

      - name: Build runtime tarball
        if: runner.os != 'Linux'
        shell: bash
        env:
          GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RPY2_CFFI_MODE: "ABI"
        run: |
          mkdir -p dist/runtime
          python -m brmspy.build --output-dir "dist/runtime" --runtime-version "$RUNTIME_VERSION"

          RUNTIME_TARBALL=$(ls dist/runtime/*.tar.gz)
          if [ -z "$RUNTIME_TARBALL" ]; then
            echo "No runtime tarball found under dist/runtime" >&2
            exit 1
          fi

          RUNTIME_FILENAME=$(basename "$RUNTIME_TARBALL")
          echo "RUNTIME_TARBALL=$RUNTIME_TARBALL" >> "$GITHUB_ENV"
          echo "RUNTIME_FILENAME=$RUNTIME_FILENAME" >> "$GITHUB_ENV"
          echo "Built runtime: $RUNTIME_TARBALL"

      # ===========================
      # Common: delete old asset
      # ===========================
      - name: Delete existing asset if it exists
        uses: actions/github-script@v7
        env:
          TAG: ${{ inputs.tag || format('runtime-{0}', inputs.runtime_version || '0.2.0') }}
          ASSET_NAME: "${{ env.RUNTIME_FILENAME }}"
        with:
          script: |
            const { owner, repo } = context.repo;
            const tag = process.env.TAG;
            const assetName = process.env.ASSET_NAME;

            const release = await github.rest.repos.getReleaseByTag({
              owner,
              repo,
              tag
            });

            const assets = release.data.assets || [];
            const existing = assets.find(a => a.name === assetName);

            if (existing) {
              core.info(`Deleting existing asset: ${assetName} (id=${existing.id})`);
              await github.rest.repos.deleteReleaseAsset({
                owner,
                repo,
                asset_id: existing.id
              });
            } else {
              core.info(`No existing asset named ${assetName}`);
            }

      # ===========================
      # Common: attest + upload
      # ===========================
      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: "${{ env.RUNTIME_TARBALL }}"

      - name: Upload runtime asset to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ${{ env.RUNTIME_TARBALL }}
          asset_name: "${{ env.RUNTIME_FILENAME }}"
          asset_content_type: application/gzip
