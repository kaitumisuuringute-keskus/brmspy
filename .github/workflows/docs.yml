name: docs

on:
  push:
    branches: [master]
    tags: ["release*"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install docs dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            mkdocs-material \
            mkdocs-jupyter \
            mkdocstrings[python] \
            mike \
            "mkdocs-shadcn@git+https://github.com/asiffer/mkdocs-shadcn@30-search-indexing-broken"

      - name: Configure git identity (for mike commits)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch gh-pages (so mike can update it)
        run: |
          git fetch origin gh-pages --depth=1 || true

      - name: Extract version from brmspy/__init__.py
        id: ver
        run: |
          python - <<'PY'
          import re, pathlib, os
          p = pathlib.Path("brmspy/__init__.py")
          s = p.read_text(encoding="utf-8")
          m = re.search(r'__version__\s*=\s*"([^"]+)"', s)
          if not m:
            raise SystemExit("Could not find __version__ in brmspy/__init__.py")
          full = m.group(1).strip()
          parts = full.split(".")
          if len(parts) < 2:
            raise SystemExit(f"Bad __version__: {full!r} (need at least MAJOR.MINOR)")
          major_minor = f"{int(parts[0])}.{int(parts[1])}"
          out = os.environ["GITHUB_OUTPUT"]
          with open(out, "a", encoding="utf-8") as f:
            f.write(f"full={full}\n")
            f.write(f"major_minor={major_minor}\n")
          print("full:", full)
          print("major_minor:", major_minor)
          PY

      # master -> dev (unreleased docs)
      - name: Deploy dev docs
        if: github.ref == 'refs/heads/master'
        run: |
          mike deploy \
            --branch gh-pages \
            --push \
            --update-aliases \
            --alias-type=redirect \
            -t "dev" \
            dev

      # tags -> major.minor + latest (title shows patch)
      - name: Verify tag matches __version__
        if: startsWith(github.ref, 'refs/tags/')
        env:
          TAG: ${{ github.ref_name }}
          FULL: ${{ steps.ver.outputs.full }}
        run: |
          if [ "$TAG" != "release-$FULL" ] && [ "$TAG" != "$FULL" ]; then
            echo "Tag ($TAG) does not match brmspy/__init__.py __version__ ($FULL)"
            exit 1
          fi

      - name: Deploy release docs + move latest + set default
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          mike deploy \
            --branch gh-pages \
            --push \
            --update-aliases \
            --alias-type=redirect \
            -t "${{ steps.ver.outputs.full }}" \
            "${{ steps.ver.outputs.major_minor }}" latest

          mike set-default \
            --branch gh-pages \
            --push \
            latest
